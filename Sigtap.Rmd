---
title: "Sigtap - SUS"
description: |
  Criando uma tabela única com os processos padronizados pelo SUS.
author:
  - name: Rodrigo Silva 
    url: https://github.com/rdsilva
    affiliation: Agência Brasileira de Apoio à Gestão do Sistema Único de Saúde - AgSUS
    affiliation_url: https://agenciasus.org.br/
date: "`r Sys.Date()`"
output: radix::radix_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Sobre

O objetivo deste estudo é criar uma tabela unificada com todos os parametros do Sigtap em uma única tabela. Isto irá gerar uma quantidade enorme de dados repetidos, contudo acredita-se que isto facilitará trabalhos futuros de consultas e processamento. Igualmente irá contribuir com a comunidade no que diz respeito a divulgação de um dataset importante para os estudos centrados no SUS. Por fim, o dataset a ser construído é praticamente fixo, onde não há a adição constante de novos valores visto que todo o tramite de atualização deve antes passar por portarias e normativas.

<aside>
Wiki [SIGTAP](https://wiki.saude.gov.br/sigtap/index.php/Gerais#Regra_Condicionada)
</aside>

Os dados do `Sigtap` são organizados em um conjunto de pouco mais de 80 arquivos, disponibilizados mensalmente pelo próprio DataSUS. Desta forma iniciaremos trabalhando com os dados das tabelas *grupo*, *subgrupo*, *forma* *organizacional*, *procedimento* e *tuss*. No futuro irei adicionar as demais informações, tais como relação com cid, com nível de atenção e outros. 

<aside>
Competência : 04/2019
</aside>

<aside>
Exemplo de Link: ftp://ftp2.datasus.gov.br/pub/sistemas/tup/downloads/TabelaUnificada_202510_v2510160954.zip
</aside>

# Bibliotecas


```{r biblioteca, eval=FALSE, message=TRUE, warning=FALSE, echo=TRUE}
library(dplyr)
library(data.table)
library(rmarkdown)
```

# Dados

## Download

```{r}
url <- 'ftp://ftp2.datasus.gov.br/pub/sistemas/tup/downloads/TabelaUnificada_202510_v2510160954.zip'
dest <- 'dados/sigtap.zip'

utils::download.file(url, 
                     destfile = dest)
```
## Unzip

```{r}
path <- 'dados/sigtap/'
unzip(dest, 
      exdir = path,
      overwrite = F,
      unzip = "unzip")
```


## Dados do Sigtap


```{r work directory, eval=FALSE, warning=FALSE, echo=TRUE}

grupo <- fread(paste0(path, 'tb_grupo.txt'), sep = '\t', encoding = 'Latin-1', header = F)
subgrupo <- fread(paste0(path, 'tb_sub_grupo.txt'), sep = '\t', encoding = 'Latin-1', header = F)
forma_organizacao <- fread(paste0(path, 'tb_forma_organizacao.txt'), sep = '\t', encoding = 'Latin-1', header = F)
procedimento <- fread(paste0(path, 'tb_procedimento.txt'), sep = '\t', encoding = 'Latin-1', header = F)

```

Os dados do Sigtap são disponibilizados em formato de texto (.txt) sem qualquer caracter separador que indique as colunas e valores. No entanto há em conjunto com os dados os documentos de *layout*, para cada uma das tabelas um documento associado.

Por hora irei fazer as transcrições no braço mesmo, em um futuro próximo ireis automatizar o processo de leitura do layout e do arquivo tabela para, já no processo de leitura, criar um data.frame. 

### Convertendo o arquivo TB_GRUPO

#### Layout do Arquivo

```{r layout grupo, message=TRUE, warning=FALSE, echo=FALSE, layout="l-body-outset"}

grupo.layout <- read.csv(paste0(path, 'tb_grupo_layout.txt'), header = TRUE, sep = ',')

paged_table(grupo.layout)
```

```{r convert tb_grupo, eval=FALSE, warning=FALSE, echo=TRUE}
grupo <- grupo %>%
  rename(grupo = V1) %>%
  mutate(co_grupo = substr(grupo, 
                           grupo.layout$Inicio[grupo.layout$Coluna == 'CO_GRUPO'],
                           grupo.layout$Fim[grupo.layout$Coluna == 'CO_GRUPO'])) %>%
  mutate(no_grupo = substr(grupo, 
                           grupo.layout$Inicio[grupo.layout$Coluna == 'NO_GRUPO'],
                           grupo.layout$Fim[grupo.layout$Coluna == 'NO_GRUPO'])) %>%
  mutate(dt_competencia = substr(grupo, 
                           grupo.layout$Inicio[grupo.layout$Coluna == 'DT_COMPETENCIA'],
                           grupo.layout$Fim[grupo.layout$Coluna == 'DT_COMPETENCIA'])) %>%
  select(-grupo) %>%
  droplevels() %>%
  data.frame()
```


### Convertendo o arquivo TB_SUB_GRUPO

#### Layout do Arquivo

```{r layout subgrupo, message=TRUE, warning=FALSE, echo=FALSE, layout="l-body-outset"}

subgrupo.layout <- read.csv(paste0(path, 'tb_sub_grupo_layout.txt'), header = TRUE, sep = ',')

paged_table(subgrupo.layout)
```

```{r convert tb_subgrupo, eval=FALSE, warning=FALSE, echo=TRUE}

subgrupo <- subgrupo %>%
  rename(grupo = V1) %>%
  mutate(co_grupo = substr(grupo, 
                           subgrupo.layout$Inicio[subgrupo.layout$Coluna == 'CO_GRUPO'],
                           subgrupo.layout$Fim[subgrupo.layout$Coluna == 'CO_GRUPO'])) %>%
  mutate(co_sub_grupo = substr(grupo, 
                           subgrupo.layout$Inicio[subgrupo.layout$Coluna == 'CO_SUB_GRUPO'],
                           subgrupo.layout$Fim[subgrupo.layout$Coluna == 'CO_SUB_GRUPO'])) %>%
  mutate(no_sub_grupo = substr(grupo, 
                           subgrupo.layout$Inicio[subgrupo.layout$Coluna == 'NO_SUB_GRUPO'],
                           subgrupo.layout$Fim[subgrupo.layout$Coluna == 'NO_SUB_GRUPO'])) %>%
  mutate(dt_competencia = substr(grupo, 
                           subgrupo.layout$Inicio[subgrupo.layout$Coluna == 'DT_COMPETENCIA'],
                           subgrupo.layout$Fim[subgrupo.layout$Coluna == 'DT_COMPETENCIA'])) %>%
  select(-grupo) %>%
  droplevels() %>%
  data.frame()

```


### Convertendo o arquivo TB_FORMA_ORGANIZACAO

#### Layout do Arquivo

```{r layout forma_organizacao, message=TRUE, warning=FALSE, echo=FALSE, layout="l-body-outset"}

forma_organizacao.layout <- read.csv(paste0(path, 'tb_forma_organizacao_layout.txt'), header = TRUE, sep = ',')

paged_table(forma_organizacao.layout)
```

```{r convert tb_forma_organizacao, eval=FALSE, warning=FALSE, echo=TRUE}

forma_organizacao <- forma_organizacao %>%
  rename(grupo = V1) %>%
  mutate(co_grupo = substr(grupo, 
                           forma_organizacao.layout$Inicio[forma_organizacao.layout$Coluna == 'CO_GRUPO'],
                           forma_organizacao.layout$Fim[forma_organizacao.layout$Coluna == 'CO_GRUPO'])) %>%
  mutate(co_sub_grupo = substr(grupo, 
                           forma_organizacao.layout$Inicio[forma_organizacao.layout$Coluna == 'CO_SUB_GRUPO'],
                           forma_organizacao.layout$Fim[forma_organizacao.layout$Coluna == 'CO_SUB_GRUPO'])) %>%
  mutate(co_forma_organizacao = substr(grupo, 
                           forma_organizacao.layout$Inicio[forma_organizacao.layout$Coluna == 'CO_FORMA_ORGANIZACAO'],
                           forma_organizacao.layout$Fim[forma_organizacao.layout$Coluna == 'CO_FORMA_ORGANIZACAO'])) %>%
  mutate(no_forma_organizacao = substr(grupo, 
                           forma_organizacao.layout$Inicio[forma_organizacao.layout$Coluna == 'NO_FORMA_ORGANIZACAO'],
                           forma_organizacao.layout$Fim[forma_organizacao.layout$Coluna == 'NO_FORMA_ORGANIZACAO'])) %>%
  mutate(dt_competencia = substr(grupo, 
                           forma_organizacao.layout$Inicio[forma_organizacao.layout$Coluna == 'DT_COMPETENCIA'],
                           forma_organizacao.layout$Fim[forma_organizacao.layout$Coluna == 'DT_COMPETENCIA'])) %>%
  select(-grupo) %>%
  droplevels() %>%
  data.frame()

```


### Convertendo o arquivo TB_PROCEDIMENTO

#### Layout do Arquivo

```{r layout procedimento, message=TRUE, warning=FALSE, echo=FALSE, layout="l-body-outset"}

procedimento.layout <- read.csv(paste0(path, 'tb_procedimento_layout.txt'), header = TRUE, sep = ',')

paged_table(procedimento.layout)
```

```{r convert tb_procedimento, eval=FALSE, warning=FALSE, echo=TRUE}

procedimento <- procedimento %>%
  rename(grupo = V1) %>%
  mutate(co_procedimento = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'CO_PROCEDIMENTO'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'CO_PROCEDIMENTO'])) %>%
  mutate(no_procedimento = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'NO_PROCEDIMENTO'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'NO_PROCEDIMENTO'])) %>%
  mutate(tp_complexidade = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'TP_COMPLEXIDADE'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'TP_COMPLEXIDADE'])) %>%
  mutate(tp_sexo = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'TP_SEXO'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'TP_SEXO'])) %>%
  mutate(qtde_max_execucao = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'QT_MAXIMA_EXECUCAO'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'QT_MAXIMA_EXECUCAO'])) %>%
  mutate(qtde_dias_permanencia = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'QT_DIAS_PERMANENCIA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'QT_DIAS_PERMANENCIA'])) %>%
  mutate(qtde_pontos = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'QT_PONTOS'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'QT_PONTOS'])) %>%
  mutate(vl_idade_minima = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'VL_IDADE_MINIMA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'VL_IDADE_MINIMA'])) %>%
  mutate(vl_idade_maxima = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'VL_IDADE_MAXIMA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'VL_IDADE_MAXIMA'])) %>%
  mutate(vl_sh = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'VL_SH'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'VL_SH'])) %>%
  mutate(vl_sa = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'VL_SA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'VL_SA'])) %>%
  mutate(vl_sp = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'VL_SP'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'VL_SP'])) %>%
  mutate(co_financiamento = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'CO_FINANCIAMENTO'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'CO_FINANCIAMENTO'])) %>%
  mutate(co_rubrica = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'CO_RUBRICA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'CO_RUBRICA'])) %>%
  mutate(qtde_tempo_permanencia = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'QT_TEMPO_PERMANENCIA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'QT_TEMPO_PERMANENCIA'])) %>%
  mutate(dt_competencia = substr(grupo, 
                           procedimento.layout$Inicio[procedimento.layout$Coluna == 'DT_COMPETENCIA'],
                           procedimento.layout$Fim[procedimento.layout$Coluna == 'DT_COMPETENCIA'])) %>%
  select(-grupo) %>%
  droplevels() %>%
  data.frame()

```

## Organizando os dados

### Merging Grupo e Subgrupo

```{r merge grupo e subgrupo, eval=FALSE, warning=FALSE, echo=TRUE}
res_temp <- merge(grupo %>% select(-dt_competencia), 
                  subgrupo %>% select(-dt_competencia),
                  by = 'co_grupo',
                  all.x = T)
```

### Merging Forma Organizacional

```{r merge res_temp e organizacao, eval=FALSE, warning=FALSE, echo=TRUE}
res_temp <- merge(res_temp, 
                  forma_organizacao %>% select(-dt_competencia), 
                  by = c('co_grupo', 'co_sub_grupo'),
                  all.x = T)
```

### Merging os Procedimentos

```{r merge res_temp 2 e procedimentos, eval=FALSE, warning=FALSE, echo=TRUE}
result <- merge(res_temp %>% mutate(co_proc = paste0(co_grupo, co_sub_grupo, co_forma_organizacao)), 
                procedimento %>% mutate(co_proc = substr(co_procedimento, 1, 6)), 
                by = 'co_proc',
                all.x = T) %>%
  select(-co_proc) %>%
  mutate(across(1:dt_competencia, stringr::str_squish))

```

## Salvando o arquivo

```{r salvando arquivo final, eval=FALSE, warning=FALSE, echo=TRUE}
arq_saida <- paste0('Resultado/tabela-sigtap-', Sys.Date(), '.csv')
fwrite(result, arq_saida, sep = ';')
```


# Procedimentos e Materiais

Materiais para procedimentos também estão salvos na tabela geral do SIGTAP, o que ocorre é que estes dados ficam salvos no grupo 07 dos procedimentos. Há então a necessidade de se descobrir como mapear esses dados...


# Compatibilidade de Procedimentos

Diversos procedimentos são correlatos, de certa forma alguns deles são compativeis uns com os outros. Desta forma esta parte do script tratará os dados de relacionamento de compatibilidade entre **procedimentos**.

A tabela que armazena esta relação é a *rl_procedimento_compativel*

```{r compatibilidade, eval=FALSE, warning=FALSE, echo=TRUE}

setwd(path)

rl_proc_comp <- iconv(read_document('rl_procedimento_compativel.txt'), "latin1", "UTF-8")

```

Separando as informações

```{r tb_compativeis, eval=FALSE, warning=FALSE, echo=TRUE}

co_procedimento <- substr(rl_proc_comp, 1, 10)
co_registro_principal <- substr(rl_proc_comp, 11, 12)
co_procedimento_compativel <- substr(rl_proc_comp, 13, 22)
co_registro_compativel <- substr(rl_proc_comp, 23, 24)
tp_compatibilidade <- substr(rl_proc_comp, 25, 25)
qt_permitida <- substr(rl_proc_comp, 26, 29)
dt_competencia <- substr(rl_proc_comp, 30, 35)

compativeis <- data.frame(co_procedimento,
                        co_registro_principal,
                        co_procedimento_compativel,
                        co_registro_compativel,
                        tp_compatibilidade,
                        qt_permitida,
                        dt_competencia)

```

```{r view tb_compativeis, eval=FALSE, message=TRUE, warning=FALSE, echo=FALSE, layout="l-body-outset"}
library(rmarkdown)

paged_table(compativeis)
```

```{r}
write.csv2(compativeis, 'sigtap-compativeis-201904.csv', row.names = FALSE)
```


# Resultados Estruturados

```{r}
library(dplyr)
library(rmarkdown)
library(textreadr)
```


## Grupos de Procedimentos

```{r}
tmp_grupos <- grupo.ds %>%
  select(co_grupo, no_grupo)

write.csv2(tmp_grupos, 'Resultado/grupos_procedimentos.csv', row.names = FALSE)
```

## Subrupos de Procedimentos

```{r}
tmp_subgrupos <- subgrupo.ds %>%
  select(co_grupo, co_sub_grupo, no_sub_grupo)

write.csv2(tmp_subgrupos, 'Resultado/subgrupos_procedimentos.csv', row.names = FALSE)
```

## Organização de Procedimentos

```{r}
tmp_organizacao <- forma_organizacao.ds %>%
  select(co_grupo, co_sub_grupo, co_forma_organizacao, no_forma_organizacao)

write.csv2(tmp_organizacao, 'Resultado/organizacao_procedimentos.csv', row.names = FALSE)
```

## Procedimentos

```{r}
tmp_procedimento <- procedimento.ds %>%
  select(co_grupo, co_sub_grupo, co_forma_organizacao, co_procedimento, no_procedimento)

write.csv2(tmp_procedimento, 'Resultado/procedimentos.csv', row.names = FALSE)
```

## Parametros dos Procedimentos

```{r}
tmp_parametros <- procedimento.ds %>%
  select(co_procedimento, qt_maxima_execucao, qt_dias_permanencia, qt_pontos, vl_idade_minima, vl_idade_maxima, 
         vl_servico_hospitalar, vl_servico_ambulatorial, vl_servico_profissional, qt_tempo_permanencia)

write.csv2(tmp_parametros, 'Resultado/parametros_procedimentos.csv', row.names = FALSE)
```

## CIDs 

```{r}
cid.layout <- read.csv('TabelaUnificada_201904_v1904100923/tb_cid_layout.txt', header = TRUE, sep = ',')
paged_table(cid.layout)
```

```{r}
cid <- iconv(read_document('TabelaUnificada_201904_v1904100923/tb_cid.txt'), "latin1", "UTF-8")

co_cid <- substr(cid, 1, 4)
no_cid <- trimws(substr(cid, 5, 104), "r")

cid.ds <- data.frame(co_cid, no_cid)

write.csv2(cid.ds, 'Resultado/cid.csv', row.names = FALSE)
```

## CIDs dos Procedimentos

```{r}
cid_procedimentos.layout <- read.csv('TabelaUnificada_201904_v1904100923/rl_procedimento_cid_layout.txt', header = TRUE, sep = ',')
paged_table(cid_procedimentos.layout)
```

```{r}
cid_procedimentos <- iconv(read_document('TabelaUnificada_201904_v1904100923/rl_procedimento_cid.txt'), "latin1", "UTF-8")

co_procedimento <- substr(cid_procedimentos, 1, 10)
co_cid <- substr(cid_procedimentos, 11, 14)

cid_procedimentos.ds <- data.frame(co_procedimento, co_cid)

write.csv2(cid_procedimentos.ds, 'Resultado/cid_procedimentos.csv', row.names = FALSE)
```

## Procedimentos Compativeis

```{r}
tmp_compativeis <- compativeis %>%
  select(co_procedimento,
                        co_registro_principal,
                        co_procedimento_compativel,
                        co_registro_compativel,
                        tp_compatibilidade,
                        qt_permitida)

write.csv2(tmp_compativeis, 'Resultado/compativeis_procedimentos.csv', row.names = FALSE)
```

## Tipo Registro

```{r}
tp_registro.layout <- read.csv('TabelaUnificada_201904_v1904100923/tb_registro_layout.txt', header = TRUE, sep = ',')
paged_table(tp_registro.layout)
```

```{r}
tp_registro <- iconv(read_document('TabelaUnificada_201904_v1904100923/tb_registro.txt'), "latin1", "UTF-8")

co_registro <- substr(tp_registro, 1, 2)
no_registro <- trimws(substr(tp_registro, 3, 52), "r")

tp_registro.ds <- data.frame(co_registro, no_registro)

write.csv2(tp_registro.ds, 'Resultado/tipo_registro.csv', row.names = FALSE)
```

## Relação Procedimentos e Registro

```{r}
procedimento_registro.layout <- read.csv('TabelaUnificada_201904_v1904100923/rl_procedimento_registro_layout.txt', 
                                         header = TRUE, sep = ',')
paged_table(procedimento_registro.layout)
```

```{r}
procedimento_registro <- iconv(read_document('TabelaUnificada_201904_v1904100923/rl_procedimento_registro.txt'), "latin1", "UTF-8")

co_procedimento <- substr(procedimento_registro, 1, 10)
co_registro <- substr(procedimento_registro, 11, 12)

procedimento_registro.ds <- data.frame(co_procedimento, co_registro)

write.csv2(procedimento_registro.ds, 'Resultado/relacao_procedimento_registro.csv', row.names = FALSE)
```

## Relação Procedimentos e Serviço

```{r}
procedimento_servico.layout <- read.csv('TabelaUnificada_201904_v1904100923/rl_procedimento_servico_layout.txt', 
                                         header = TRUE, sep = ',')
paged_table(procedimento_servico.layout)
```

```{r}
procedimento_servico <- iconv(read_document('TabelaUnificada_201904_v1904100923/rl_procedimento_servico.txt'), "latin1", "UTF-8")

co_procedimento <- substr(procedimento_servico, 1, 10)
co_servico <- substr(procedimento_servico, 11, 13)

procedimento_servico.ds <- data.frame(co_procedimento, co_servico)

write.csv2(procedimento_servico.ds, 'Resultado/relacao_procedimento_servico.csv', row.names = FALSE)
```

## Tipo de Serviço

```{r}
servico.layout <- read.csv('TabelaUnificada_201904_v1904100923/tb_servico_layout.txt', 
                                         header = TRUE, sep = ',')
paged_table(servico.layout)
```

```{r}
servico <- iconv(read_document('TabelaUnificada_201904_v1904100923/tb_servico.txt'), "latin1", "UTF-8")

co_servico <- substr(servico, 1, 3)
no_servico <- trimws(substr(servico, 4, 123), "r")

servico.ds <- data.frame(co_servico, no_servico)

write.csv2(servico.ds, 'Resultado/servicos.csv', row.names = FALSE)
```

